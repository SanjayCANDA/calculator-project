#.gitlab-ci.yml - CI/CD pour projet Python avec GitLab CI
# Variables globales (tous jobs)
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"  # Cache pip

# Image Python unifiée
image: python:3.12

# Stages = ordre exécution
stages:
  - test
  - metrics
  - build
  - deploy-test
  - deploy-prod

# Cache pip (matrix Python)
.cache-pip:
  key:
    files:
      - pyproject.toml
      - poetry.lock  # Si poetry

test:
  stage: test
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.10", "3.12"]
  image: python:${PYTHON_VERSION}-slim
  script:
    - pip install --upgrade pip
    - make install
    - make test-smoke
    - make uninstall
    - make install-dev
    - make ci
  cache:
    paths:
      - .cache/pip/
  artifacts:
    paths:
      - .coverage  # Si coverage reports

metrics:
  stage: metrics
  image: python:3.12-slim
  script:
    - make install-dev
    - make metrics-all
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

build:
  stage: build
  image: python:3.12-slim
  needs: ["test"]  # Comme needs: test
  script:
    - make build  # Pas install-dev !
  artifacts:
    paths:
      - dist/*  # Wheel + sdist (équivalent upload-artifact)

deploy-test:
  stage: deploy-test
  image: python:3.12-slim
  needs: ["build"]
  rules:
    - if: $CI_COMMIT_BRANCH == "main"  # Comme github.ref == main
  script:
    - make deploy-test
  variables:
    TWINE_USERNAME: "__token__"
    TWINE_PASSWORD: $TESTPYPI_TOKEN

deploy-prod:
  stage: deploy-prod
  image: python:3.12-slim
  needs: ["build"]
  rules:
    - if: $CI_COMMIT_TAG  # Comme startsWith(tag)
  script:
    - make deploy
  variables:
    TWINE_USERNAME: "__token__"
    TWINE_PASSWORD: $PYPI_TOKEN